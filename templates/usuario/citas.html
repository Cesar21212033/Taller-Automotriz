{% extends "usuario/base.html" %}

{% block title %}Mis Citas{% endblock %}

{% block user_content %}
<h2>Mis Citas</h2>
    <p class="mb-20 text-muted">
    Aqu铆 puedes ver todas las citas que has agendado.
</p>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Servicio</th>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Estatus</th>
                <th>Cotizaci贸n</th>
                <th>Fecha de Registro</th>
            </tr>
        </thead>
        <tbody>
            {% if citas %}
                {% for cita in citas %}
                    <tr>
                        <td>
                            {% if cita.servicios_relacionados and cita.servicios_relacionados|length > 0 %}
                                <div>
                                    {% for servicio in cita.servicios_relacionados %}
                                        <span style="display: inline-block; background-color: #e7f3ff; padding: 4px 8px; border-radius: 4px; margin: 2px; font-size: 0.9em;">
                                            {{ servicio.nombre }}
                                        </span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                {{ cita.servicio or 'N/A' }}
                            {% endif %}
                        </td>
                        <td>{{ cita.fecha }}</td>
                        <td>
                            {% if cita.hora %}
                                {% if cita.hora is string %}
                                    {{ cita.hora }}
                                {% else %}
                                    {% set h = cita.hora.hour %}
                                    {% set m = cita.hora.minute %}
                                    {% if h == 0 %}
                                        {% set hora12 = 12 %}
                                        {% set ampm = 'AM' %}
                                    {% elif h < 12 %}
                                        {% set hora12 = h %}
                                        {% set ampm = 'AM' %}
                                    {% elif h == 12 %}
                                        {% set hora12 = 12 %}
                                        {% set ampm = 'PM' %}
                                    {% else %}
                                        {% set hora12 = h - 12 %}
                                        {% set ampm = 'PM' %}
                                    {% endif %}
                                    {{ "%d:%02d %s"|format(hora12, m, ampm) }}
                                {% endif %}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>
                            <span class="estatus-badge estatus-{{ cita.estatus|lower|replace(' ', '-') if cita.estatus else 'pendiente' }}">
                                {{ cita.estatus or 'Pendiente' }}
                            </span>
                        </td>
                        <td>
                            {% if cita.cotizacion_id %}
                            <div style="background-color: #e7f3ff; padding: 8px; border-radius: 5px; border-left: 3px solid #2196F3;">
                                <p style="margin: 0; font-size: 0.9em;">
                                    <strong style="color: #1976D2;"> Cotizaci贸n #{{ cita.cotizacion_id }}</strong>
                                </p>
                                {% if cita.cotizacion_precio %}
                                <p style="margin: 5px 0 0 0; font-size: 0.95em;">
                                    <strong style="color: #28a745;">${{ "%.2f"|format(cita.cotizacion_precio) }}</strong>
                                </p>
                                {% endif %}
                                {% if cita.cotizacion_marca %}
                                <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #666;">
                                    {{ cita.cotizacion_marca }}
                                    {% if cita.cotizacion_modelo %}{{ cita.cotizacion_modelo }}{% endif %}
                                    {% if cita.cotizacion_anio %}({{ cita.cotizacion_anio }}){% endif %}
                                </p>
                                {% endif %}
                                <button onclick="verCotizacion({{ cita.cotizacion_id }})" 
                                        style="margin-top: 5px; background-color: #17a2b8; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                    Ver Detalles
                                </button>
                            </div>
                            {% else %}
                            <span class="text-muted" style="font-size: 0.9em;">Sin cotizaci贸n</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if cita.fecha_registro %}
                                {{ cita.fecha_registro.strftime('%d/%m/%Y %H:%M') if cita.fecha_registro else 'N/A' }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="6" class="table-empty">
                        No tienes citas registradas.<br>
                        <a href="{{ url_for('citas') }}">Agendar una cita</a>
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Modal para ver detalles de cotizaci贸n -->
<div id="modalCotizacion" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 80%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
        <span onclick="cerrarModalCotizacion()" style="float: right; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa;">&times;</span>
        <h3>Detalles de la Cotizaci贸n</h3>
        <div id="cotizacionContenido"></div>
    </div>
</div>

<script>
function verCotizacion(cotizacionId) {
    // Cargar detalles de la cotizaci贸n desde el servidor
    fetch(`/usuario/cotizaciones/${cotizacionId}/detalles`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const cotizacion = data.cotizacion;
                let html = `
                    <div style="margin-top: 20px;">
                        <p><strong>ID Cotizaci贸n:</strong> #${cotizacion.id || cotizacion.cotizacion_id}</p>
                        <p><strong>Servicio:</strong> ${cotizacion.servicio || cotizacion.servicio_nombre || 'N/A'}</p>
                        <p><strong>Veh铆culo:</strong> ${cotizacion.marca_vehiculo || 'N/A'} ${cotizacion.modelo_vehiculo || ''}</p>
                        <p><strong>A帽o:</strong> ${cotizacion.anio_vehiculo || 'N/A'}</p>
                        <p><strong>Cilindros:</strong> ${cotizacion.cilindros || 'N/A'}</p>
                        <p><strong>Precio Estimado:</strong> <span style="color: #28a745; font-size: 1.2em; font-weight: bold;">$${parseFloat(cotizacion.precio_calculado || 0).toFixed(2)}</span></p>
                        <p><strong>Fecha de Solicitud:</strong> ${new Date(cotizacion.fecha_envio).toLocaleDateString('es-MX')}</p>
                        ${cotizacion.mensaje ? `<p><strong>Comentarios:</strong><br>${cotizacion.mensaje}</p>` : ''}
                    </div>
                `;
                document.getElementById('cotizacionContenido').innerHTML = html;
                document.getElementById('modalCotizacion').style.display = 'block';
            } else {
                alert('Error al cargar la cotizaci贸n: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar la cotizaci贸n');
        });
}

function cerrarModalCotizacion() {
    document.getElementById('modalCotizacion').style.display = 'none';
}

// Cerrar modal al hacer clic fuera
window.onclick = function(event) {
    const modal = document.getElementById('modalCotizacion');
    if (event.target == modal) {
        cerrarModalCotizacion();
    }
}
</script>

<style>
.estatus-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.85em;
    font-weight: 500;
}

.estatus-pendiente {
    background-color: #ffc107;
    color: #000;
}

.estatus-confirmada {
    background-color: #28a745;
    color: white;
}

.estatus-en-proceso {
    background-color: #17a2b8;
    color: white;
}

.estatus-completada {
    background-color: #6c757d;
    color: white;
}

.estatus-cancelada {
    background-color: #dc3545;
    color: white;
}
</style>
{% endblock %}

