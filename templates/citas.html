{% extends "base.html" %}

{% block title %}Agendar Cita - Servicio Automotriz{% endblock %}

{% block content %}
<div class="form-container">
    <h2>Agendar Cita</h2>
    
    {% if cotizacion %}
    <div style="background-color: #e7f3ff; border-left: 4px solid #2196F3; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
        <p style="margin: 0; color: #1976D2;"><strong>üìã Cotizaci√≥n seleccionada:</strong></p>
        <p style="margin: 5px 0 0 0;">
            <strong>Servicio:</strong> {{ cotizacion.servicio_nombre or cotizacion.servicio }} | 
            <strong>Precio estimado:</strong> ${{ "%.2f"|format(cotizacion.precio_calculado) if cotizacion.precio_calculado else 'N/A' }}
        </p>
        <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #666;">
            El servicio ya est√° pre-seleccionado. Solo necesitas elegir fecha y hora.
        </p>
    </div>
    {% endif %}
    
    <form method="POST" action="{{ url_for('citas') }}" id="formCitas" onsubmit="return validarFormularioCitas()">
        {% if cotizacion %}
        <input type="hidden" name="cotizacion_id" value="{{ cotizacion.cotizacion_id }}">
        {% endif %}
        {% if usuario and usuario.usuario_id %}
        {# Usuario logueado: mostrar informaci√≥n pero no campos editables #}
        <div class="form-group" style="background-color: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <p style="margin: 0; color: #666; font-size: 14px;"><strong>Datos de tu cuenta:</strong></p>
            <p style="margin: 5px 0 0 0; color: #333;"><strong>Nombre:</strong> {{ usuario.nombre }}</p>
            <p style="margin: 5px 0 0 0; color: #333;"><strong>Email:</strong> {{ usuario.email }}</p>
            {% if usuario.telefono %}
            <p style="margin: 5px 0 0 0; color: #333;"><strong>Tel√©fono:</strong> {{ usuario.telefono }}</p>
            {% endif %}
        </div>
        {# Campos ocultos con los datos del usuario para el POST #}
        <input type="hidden" name="nombre" value="{{ usuario.nombre }}">
        <input type="hidden" name="email" value="{{ usuario.email }}">
        {% if usuario.telefono %}
        <input type="hidden" name="telefono" value="{{ usuario.telefono }}">
        {% endif %}
        {% else %}
        {# Usuario no logueado: mostrar campos editables #}
        <div class="form-group">
            <label for="nombre">Nombre:</label>
            <input type="text" id="nombre" name="nombre" required>
        </div>

        <div class="form-group">
            <label for="telefono">Tel√©fono:</label>
            <input type="tel" id="telefono" name="telefono" required>
        </div>

        <div class="form-group">
            <label for="email">Correo Electr√≥nico:</label>
            <input type="email" id="email" name="email" required>
        </div>
        {% endif %}

        <div class="form-group">
            <label for="fecha">Fecha:</label>
            <input type="date" id="fecha" name="fecha" required>
            <small class="text-muted d-block mt-5">Seleccione una fecha futura</small>
        </div>

        <div class="form-group">
            <label for="hora">Hora:</label>
            <select id="hora" name="hora" required disabled>
                <option value="">Primero seleccione una fecha</option>
            </select>
            <small id="hora_help" class="text-muted d-block mt-5">Horario disponible: 7:00 AM - 5:00 PM</small>
        </div>

        <div class="form-group">
            <label for="servicio_id">Servicios * (Puedes seleccionar m√∫ltiples servicios)</label>
            {% if cotizacion and cotizacion.servicio_id %}
            {# Si viene desde una cotizaci√≥n, mostrar solo el servicio seleccionado como campo oculto #}
            <input type="hidden" name="servicio_id[]" value="{{ cotizacion.servicio_id }}">
            <div style="padding: 10px; background-color: #e7f3ff; border-radius: 5px; border-left: 3px solid #2196F3;">
                <p style="margin: 0;"><strong>Servicio pre-seleccionado:</strong> {{ cotizacion.servicio_nombre or cotizacion.servicio }}</p>
                <small class="text-muted">Este servicio viene de tu cotizaci√≥n</small>
            </div>
            {% else %}
            <select id="servicio_id" name="servicio_id[]" multiple required size="6" style="min-height: 120px;">
                {% for servicio in servicios %}
                    <option value="{{ servicio.servicio_id }}">{{ servicio.nombre }}</option>
                {% endfor %}
            </select>
            <small class="text-muted d-block mt-5">
                üí° Mant√©n presionada la tecla <strong>Ctrl</strong> (Windows) o <strong>Cmd</strong> (Mac) para seleccionar m√∫ltiples servicios
            </small>
            <div id="serviciosSeleccionados" style="margin-top: 10px; padding: 10px; background-color: #f0f0f0; border-radius: 5px; display: none;">
                <strong>Servicios seleccionados:</strong>
                <ul id="listaServicios" style="margin: 5px 0 0 0; padding-left: 20px;"></ul>
            </div>
            {% endif %}
        </div>

        <div class="button-container">
            <button type="submit">Agendar</button>
        </div>
    </form>
</div>

<script>
function initCitas() {
    const fechaInput = document.getElementById('fecha');
    const horaSelect = document.getElementById('hora');
    const horaHelp = document.getElementById('hora_help');
    
    if (!fechaInput || !horaSelect) {
        return;
    }
    
    const hoy = new Date();
    const fechaMinima = hoy.toISOString().split('T')[0];
    fechaInput.setAttribute('min', fechaMinima);
    
    fechaInput.addEventListener('change', function() {
        const fechaSeleccionada = new Date(this.value);
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        
        if (fechaSeleccionada < hoy) {
            alert('Por favor seleccione una fecha futura');
            this.value = fechaMinima;
            return;
        }
        
        cargarHorariosDisponibles(this.value);
    });
}

function cargarHorariosDisponibles(fecha) {
    const horaSelect = document.getElementById('hora');
    const horaHelp = document.getElementById('hora_help');
    
    horaSelect.innerHTML = '<option value="">Cargando horarios disponibles...</option>';
    horaSelect.disabled = true;
    
    if (!fecha) {
        horaSelect.innerHTML = '<option value="">Primero seleccione una fecha</option>';
        return;
    }
    
    fetch(`/api/horarios_disponibles/${fecha}`)
        .then(response => response.json())
        .then(data => {
            horaSelect.innerHTML = '<option value="">Seleccione un horario</option>';
            
            if (data.error) {
                console.error('Error:', data.error);
                horaSelect.innerHTML = '<option value="">Error al cargar horarios</option>';
                horaHelp.textContent = 'Error al cargar horarios disponibles';
                return;
            }
            
            if (data.horarios && data.horarios.length > 0) {
                data.horarios.forEach(horario => {
                    const option = document.createElement('option');
                    option.value = horario;
                    
                    const [hora, minuto] = horario.split(':');
                    const horaNum = parseInt(hora);
                    const ampm = horaNum >= 12 ? 'PM' : 'AM';
                    const hora12 = horaNum > 12 ? horaNum - 12 : (horaNum === 0 ? 12 : horaNum);
                    option.textContent = `${hora12}:${minuto} ${ampm}`;
                    
                    horaSelect.appendChild(option);
                });
                
                horaSelect.disabled = false;
                horaHelp.textContent = `${data.horarios.length} horarios disponibles para esta fecha`;
            } else {
                horaSelect.innerHTML = '<option value="">No hay horarios disponibles</option>';
                horaHelp.textContent = 'No hay horarios disponibles para esta fecha. Por favor seleccione otra fecha.';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            horaSelect.innerHTML = '<option value="">Error al cargar horarios</option>';
            horaHelp.textContent = 'Error al cargar horarios disponibles';
        });
}

function actualizarServiciosSeleccionados() {
    const servicioSelect = document.getElementById('servicio_id');
    const serviciosSeleccionadosDiv = document.getElementById('serviciosSeleccionados');
    const listaServicios = document.getElementById('listaServicios');
    
    if (!servicioSelect || servicioSelect.disabled) return;
    
    const seleccionados = Array.from(servicioSelect.selectedOptions);
    
    if (seleccionados.length > 0) {
        listaServicios.innerHTML = '';
        seleccionados.forEach(option => {
            const li = document.createElement('li');
            li.textContent = option.text;
            listaServicios.appendChild(li);
        });
        serviciosSeleccionadosDiv.style.display = 'block';
    } else {
        serviciosSeleccionadosDiv.style.display = 'none';
    }
}

function validarFormularioCitas() {
    const servicioSelect = document.getElementById('servicio_id');
    const serviciosHidden = document.querySelectorAll('input[name="servicio_id[]"][type="hidden"]');
    
    // Si hay un select m√∫ltiple
    if (servicioSelect && !servicioSelect.disabled) {
        const seleccionados = Array.from(servicioSelect.selectedOptions);
        if (seleccionados.length === 0) {
            alert('Por favor seleccione al menos un servicio');
            servicioSelect.focus();
            return false;
        }
    } else if (serviciosHidden.length === 0) {
        // Si no hay select ni campos ocultos, algo est√° mal
        alert('Por favor seleccione al menos un servicio');
        return false;
    }
    
    return true;
}

document.addEventListener('DOMContentLoaded', function() {
    initCitas();
    
    const servicioSelect = document.getElementById('servicio_id');
    if (servicioSelect && !servicioSelect.disabled) {
        servicioSelect.addEventListener('change', actualizarServiciosSeleccionados);
        actualizarServiciosSeleccionados(); // Actualizar al cargar si hay selecciones
    }
});
</script>
{% endblock %}

