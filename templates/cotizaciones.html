{% extends "base.html" %}

{% block title %}Cotizaciones - Servicio Automotriz{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/cotizaciones.css') }}">
<style>
/* Utilidades */
.text-center {
    text-align: center;
}

.text-muted {
    color: #666;
}

.mb-20 {
    margin-bottom: 20px;
}
</style>
{% endblock %}

{% block content %}
<section class="form-container">
    <h2>Solicita una Cotizaci칩n Personalizada</h2>
    <p class="text-center text-muted mb-20">
        Ingresa los datos de tu veh칤culo para obtener un precio personalizado seg칰n el servicio, cilindros y a침o.
    </p>
    
    <form method="POST" action="{{ url_for('cotizaciones') }}" id="formCotizacion">
        {% if usuario and usuario.usuario_id %}
        {# Usuario logueado: mostrar informaci칩n pero no campos editables #}
        <div class="form-group" style="background-color: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <p style="margin: 0; color: #666; font-size: 14px;"><strong>Datos de tu cuenta:</strong></p>
            <p style="margin: 5px 0 0 0; color: #333;"><strong>Nombre:</strong> {{ usuario.nombre }}</p>
            <p style="margin: 5px 0 0 0; color: #333;"><strong>Email:</strong> {{ usuario.email }}</p>
            {% if usuario.telefono %}
            <p style="margin: 5px 0 0 0; color: #333;"><strong>Tel칠fono:</strong> {{ usuario.telefono }}</p>
            {% endif %}
        </div>
        {# Campos ocultos con los datos del usuario para el POST #}
        <input type="hidden" name="nombre" value="{{ usuario.nombre }}">
        <input type="hidden" name="email" value="{{ usuario.email }}">
        {% if usuario.telefono %}
        <input type="hidden" name="telefono" value="{{ usuario.telefono }}">
        {% endif %}
        {% else %}
        {# Usuario no logueado: mostrar campos editables #}
        <div class="form-group">
            <label for="nombre">Nombre Completo *</label>
            <input type="text" id="nombre" name="nombre" required>
        </div>

        <div class="form-group">
            <label for="telefono">Tel칠fono *</label>
            <input type="tel" id="telefono" name="telefono" required>
        </div>

        <div class="form-group">
            <label for="email">Correo Electr칩nico *</label>
            <input type="email" id="email" name="email" required>
        </div>
        {% endif %}

        <div class="form-group">
            <label for="servicio_id">Servicios * (Puedes seleccionar m칰ltiples servicios)</label>
            <select id="servicio_id" name="servicio_id[]" multiple required size="6" style="min-height: 120px;">
                {% for servicio in servicios %}
                    <option value="{{ servicio.servicio_id }}">{{ servicio.nombre }}</option>
                {% endfor %}
            </select>
            <small class="text-muted d-block mt-5">
                游눠 Mant칠n presionada la tecla <strong>Ctrl</strong> (Windows) o <strong>Cmd</strong> (Mac) para seleccionar m칰ltiples servicios
            </small>
            <div id="serviciosSeleccionados" style="margin-top: 10px; padding: 10px; background-color: #f0f0f0; border-radius: 5px; display: none;">
                <strong>Servicios seleccionados:</strong>
                <ul id="listaServicios" style="margin: 5px 0 0 0; padding-left: 20px;"></ul>
            </div>
        </div>

        <h3 style="margin-top: 30px; margin-bottom: 15px; color: #333;">Datos del Veh칤culo</h3>

        <div class="form-group">
            <label for="marca_vehiculo">Marca del Veh칤culo *</label>
            <select id="marca_vehiculo" name="marca_vehiculo" required>
                <option value="">Seleccione una marca</option>
                {% for marca in marcas %}
                    <option value="{{ marca.nombre }}">{{ marca.nombre }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="modelo_vehiculo">Modelo del Veh칤culo</label>
            <input type="text" id="modelo_vehiculo" name="modelo_vehiculo" placeholder="Ej: Corolla, Civic, etc.">
        </div>

        <div class="form-group">
            <label for="a침o_id">A침o del Veh칤culo *</label>
            <select id="a침o_id" name="a침o_id" required onchange="calcularPrecio()">
                <option value="">Seleccione un a침o</option>
                {% for a침o in a침os %}
                    <option value="{{ a침o.id }}" data-a침o="{{ a침o.a침o }}">{{ a침o.a침o }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="cilindros">N칰mero de Cilindros *</label>
            <select id="cilindros" name="cilindros" required onchange="calcularPrecio()">
                <option value="">Seleccione</option>
                <option value="4">4 Cilindros</option>
                <option value="6">6 Cilindros</option>
                <option value="8">8 Cilindros</option>
                <option value="10">10 Cilindros</option>
                <option value="12">12 Cilindros</option>
            </select>
        </div>
        
        <div class="precio-preview" id="precioPreview">
            <h3>Precio Estimado:</h3>
            <div class="precio" id="precioCalculado">$0.00</div>
            <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">
                Este es un precio estimado. El precio final puede variar despu칠s de la revisi칩n del veh칤culo.
            </p>
        </div>
        
        <div class="form-group">
            <label for="mensaje">Mensaje o Comentarios Adicionales:</label>
            <textarea id="mensaje" name="mensaje" rows="4" placeholder="Describe cualquier detalle adicional sobre el servicio que necesitas..."></textarea>
        </div>
        
        <div class="button-container">
            <button type="submit">Enviar Cotizaci칩n</button>
        </div>
    </form>
</section>

<script>
function actualizarServiciosSeleccionados() {
    const servicioSelect = document.getElementById('servicio_id');
    const serviciosSeleccionadosDiv = document.getElementById('serviciosSeleccionados');
    const listaServicios = document.getElementById('listaServicios');
    
    const seleccionados = Array.from(servicioSelect.selectedOptions);
    
    if (seleccionados.length > 0) {
        listaServicios.innerHTML = '';
        seleccionados.forEach(option => {
            const li = document.createElement('li');
            li.textContent = option.text;
            listaServicios.appendChild(li);
        });
        serviciosSeleccionadosDiv.style.display = 'block';
    } else {
        serviciosSeleccionadosDiv.style.display = 'none';
    }
    
    calcularPrecio();
}

function calcularPrecio() {
    const servicioSelect = document.getElementById('servicio_id');
    const a침oSelect = document.getElementById('a침o_id');
    const cilindrosSelect = document.getElementById('cilindros');
    const precioPreview = document.getElementById('precioPreview');
    const precioCalculado = document.getElementById('precioCalculado');
    
    const serviciosSeleccionados = Array.from(servicioSelect.selectedOptions).map(opt => opt.value);
    const a침oOption = a침oSelect.options[a침oSelect.selectedIndex];
    const a침o = a침oOption ? a침oOption.getAttribute('data-a침o') : '';
    const cilindros = cilindrosSelect.value;
    
    if (serviciosSeleccionados.length > 0 && a침o && cilindros) {
        // Calcular precio total sumando todos los servicios seleccionados
        let precioTotal = 0;
        let promesas = [];
        
        serviciosSeleccionados.forEach(servicioId => {
            const promesa = fetch('{{ url_for("calcular_precio") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `servicio_id=${servicioId}&anio=${a침o}&cilindros=${cilindros}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.precio) {
                    precioTotal += parseFloat(data.precio);
                }
            })
            .catch(error => {
                console.error('Error al calcular precio:', error);
            });
            promesas.push(promesa);
        });
        
        Promise.all(promesas).then(() => {
            if (precioTotal > 0) {
                precioCalculado.textContent = '$' + precioTotal.toFixed(2);
                precioPreview.classList.add('show');
            } else {
                precioPreview.classList.remove('show');
            }
        });
    } else {
        precioPreview.classList.remove('show');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const servicioSelect = document.getElementById('servicio_id');
    if (servicioSelect) {
        servicioSelect.addEventListener('change', actualizarServiciosSeleccionados);
    }
    
    const a침oSelect = document.getElementById('a침o_id');
    if (a침oSelect) {
        a침oSelect.addEventListener('change', calcularPrecio);
    }
    
    const cilindrosSelect = document.getElementById('cilindros');
    if (cilindrosSelect) {
        cilindrosSelect.addEventListener('change', calcularPrecio);
    }
});
</script>
{% endblock %}
